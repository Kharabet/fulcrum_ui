{"version":3,"file":"promises.js","sourceRoot":"","sources":["../../../src/util/promises.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA;;;GAGG;AACH,MAAM,UAAU,SAAS,CACvB,CAAsC;IAEtC,OAAO,IAAI,OAAO,CAAC,UAAC,OAAO,EAAE,MAAM;QACjC,OAAA,CAAC,CAAC,UAAC,KAAK,EAAE,MAAM;YACd,IAAI,KAAK,IAAI,IAAI,EAAE;gBACjB,MAAM,CAAC,KAAK,CAAC,CAAC;aACf;iBAAM;gBACL,OAAO,CAAC,MAAM,CAAC,CAAC;aACjB;QACH,CAAC,CAAC;IANF,CAME,CACH,CAAC;AACJ,CAAC;AAED;;;GAGG;AACH,MAAM,UAAU,YAAY,CAC1B,OAAmB,EACnB,QAAyB;IAEzB,OAAO,CAAC,IAAI,CAAC,UAAA,MAAM,IAAI,OAAA,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAC,EAAtB,CAAsB,EAAE,UAAA,KAAK,IAAI,OAAA,QAAQ,CAAC,KAAK,CAAC,EAAf,CAAe,CAAC,CAAC;AAC3E,CAAC;AAED,MAAM,UAAU,KAAK,CAAC,EAAU;IAC9B,OAAO,IAAI,OAAO,CAAC,UAAA,OAAO,IAAI,OAAA,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC,EAAvB,CAAuB,CAAC,CAAC;AACzD,CAAC;AAED,MAAM,UAAU,WAAW,CAAI,OAAmB,EAAE,EAAU;IAC5D,OAAO,OAAO,CAAC,IAAI,CAAC;QAClB,OAAO;QACP,IAAI,OAAO,CAAI,UAAC,CAAC,EAAE,MAAM;YACvB,OAAA,UAAU,CAAC,cAAM,OAAA,MAAM,CAAC,IAAI,KAAK,CAAC,SAAS,CAAC,CAAC,EAA5B,CAA4B,EAAE,EAAE,CAAC;QAAlD,CAAkD,CACnD;KACF,CAAC,CAAC;AACL,CAAC;AAED,IAAM,eAAe,GAAG,IAAI,CAAC;AAC7B,IAAM,oBAAoB,GAAG,CAAC,CAAC;AAC/B,IAAM,eAAe,GAAG,KAAK,CAAC;AAE9B,MAAM,UAAgB,kBAAkB,CACtC,CAAmB,EACnB,UAAkB,EAClB,WAAqD;IAArD,4BAAA,EAAA,4BAAiD,OAAA,IAAI,EAAJ,CAAI;;;;;;oBAEjD,YAAY,GAAG,CAAC,CAAC;oBACjB,CAAC,GAAG,CAAC,CAAC;;;yBACH,IAAI;;;;oBAEA,qBAAM,CAAC,EAAE,EAAA;wBAAhB,sBAAO,SAAS,EAAC;;;oBAEjB,CAAC,EAAE,CAAC;oBACJ,IAAI,CAAC,IAAI,UAAU,IAAI,CAAC,WAAW,CAAC,OAAK,CAAC,EAAE;wBAC1C,MAAM,OAAK,CAAC;qBACb;oBACD,qBAAM,KAAK,CAAC,YAAY,CAAC,EAAA;;oBAAzB,SAAyB,CAAC;oBAC1B,IAAI,CAAC,WAAW,CAAC,OAAK,CAAC,EAAE;wBACvB,MAAM,OAAK,CAAC;qBACb;oBACD,YAAY;wBACV,YAAY,KAAK,CAAC;4BAChB,CAAC,CAAC,eAAe;4BACjB,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,eAAe,EAAE,oBAAoB,GAAG,YAAY,CAAC,CAAC;;;;;;;CAG1E;AAOD,MAAM,UAAU,eAAe;IAC7B,IAAI,SAAS,GAAG,KAAK,CAAC;IACtB,OAAO,EAAE,MAAM,EAAE,cAAM,OAAA,CAAC,SAAS,GAAG,IAAI,CAAC,EAAlB,CAAkB,EAAE,WAAW,EAAE,cAAM,OAAA,SAAS,EAAT,CAAS,EAAE,CAAC;AAC5E,CAAC;AAED,MAAM,UAAU,gBAAgB,CAAC,WAA0B;IACzD,IAAI,WAAW,EAAE,EAAE;QACjB,MAAM,SAAS,CAAC;KACjB;AACH,CAAC;AAED,MAAM,CAAC,IAAM,SAAS,GAAG,IAAI,KAAK,CAAC,WAAW,CAAC,CAAC","sourcesContent":["import { Web3Callback } from \"../types\";\r\n\r\n/**\r\n * Helper for converting functions which take a callback as their final argument\r\n * to functions which return a promise.\r\n */\r\nexport function promisify<T>(\r\n  f: (callback: Web3Callback<T>) => void,\r\n): Promise<T> {\r\n  return new Promise((resolve, reject) =>\r\n    f((error, result) => {\r\n      if (error != null) {\r\n        reject(error);\r\n      } else {\r\n        resolve(result);\r\n      }\r\n    }),\r\n  );\r\n}\r\n\r\n/**\r\n * Helper for converting functions which return a promise to functions which\r\n * take a callback as their final argument.\r\n */\r\nexport function callWhenDone<T>(\r\n  promise: Promise<T>,\r\n  callback: Web3Callback<T>,\r\n): void {\r\n  promise.then(result => callback(null, result), error => callback(error));\r\n}\r\n\r\nexport function delay(ms: number): Promise<void> {\r\n  return new Promise(resolve => setTimeout(resolve, ms));\r\n}\r\n\r\nexport function withTimeout<T>(promise: Promise<T>, ms: number): Promise<T> {\r\n  return Promise.race([\r\n    promise,\r\n    new Promise<T>((_, reject) =>\r\n      setTimeout(() => reject(new Error(\"Timeout\")), ms),\r\n    ),\r\n  ]);\r\n}\r\n\r\nconst MIN_RETRY_DELAY = 1000;\r\nconst RETRY_BACKOFF_FACTOR = 2;\r\nconst MAX_RETRY_DELAY = 30000;\r\n\r\nexport async function withBackoffRetries<T>(\r\n  f: () => Promise<T>,\r\n  retryCount: number,\r\n  shouldRetry: (error: unknown) => boolean = () => true,\r\n): Promise<T> {\r\n  let nextWaitTime = 0;\r\n  let i = 0;\r\n  while (true) {\r\n    try {\r\n      return await f();\r\n    } catch (error) {\r\n      i++;\r\n      if (i >= retryCount || !shouldRetry(error)) {\r\n        throw error;\r\n      }\r\n      await delay(nextWaitTime);\r\n      if (!shouldRetry(error)) {\r\n        throw error;\r\n      }\r\n      nextWaitTime =\r\n        nextWaitTime === 0\r\n          ? MIN_RETRY_DELAY\r\n          : Math.min(MAX_RETRY_DELAY, RETRY_BACKOFF_FACTOR * nextWaitTime);\r\n    }\r\n  }\r\n}\r\n\r\nexport interface CancelToken {\r\n  cancel(): void;\r\n  isCancelled(): boolean;\r\n}\r\n\r\nexport function makeCancelToken(): CancelToken {\r\n  let cancelled = false;\r\n  return { cancel: () => (cancelled = true), isCancelled: () => cancelled };\r\n}\r\n\r\nexport function throwIfCancelled(isCancelled: () => boolean): void {\r\n  if (isCancelled()) {\r\n    throw CANCELLED;\r\n  }\r\n}\r\n\r\nexport const CANCELLED = new Error(\"Cancelled\");\r\n"]}